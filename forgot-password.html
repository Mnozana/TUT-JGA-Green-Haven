<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Green Haven</title>
    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="forgot-password.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        /* Additional styles for the multi-step form */
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 35px;
            cursor: pointer;
            color: #666;
        }
        .password-input-container {
            position: relative;
        }
        .error-message {
            color: #d32f2f;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Green Haven</div>
        <nav>
            <ul>
                <li><a href="index.html">Login</a></li>
                <li><a href="signup.html">Sign Up</a></li>
            </ul>
        </nav>
    </header>

    <main class="forgot-password-container">
        <section class="forgot-password-hero" style="background-image: url('images/cover.jpg')">
            <div class="forgot-password-overlay"></div>
            <div class="forgot-password-content">
                <h1>Reset Your Password</h1>
                <p>We'll help you get back to your gardening resources</p>
            </div>
        </section>

        <section class="forgot-password-form-section">
            <div class="forgot-password-form-container">
                <div class="progress-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="line"></div>
                    <div class="step" id="step2">2</div>
                    <div class="line"></div>
                    <div class="step" id="step3">3</div>
                </div>
                
                <!-- Step 1: Find Account -->
                <div class="step-content active" id="step1Content">
                    <h2>Find Your Account</h2>
                    <p class="instruction">Enter your Haven ID or email address associated with your account.</p>
                    
                    <form class="forgot-password-form" id="forgotPasswordForm">
                        <div class="form-group">
                            <label for="user-identifier">Haven ID or Email</label>
                            <input type="text" id="user-identifier" name="user-identifier" placeholder="Enter your Haven ID or email" required>
                            <div id="identifier-error" class="error-message"></div>
                        </div>
                        
                        <button type="button" class="submit-button" id="continueButton">
                            <span id="continueText">Continue</span>
                            <span id="continueLoading" style="display: none;">Checking...</span>
                        </button>
                        
                        <div class="back-to-login">
                            <p><a href="index.html">‚Üê Back to Login</a></p>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Verification Code -->
                <div class="step-content" id="step2Content">
                    <h2>Verify Your Identity</h2>
                    <p class="instruction">We've sent a verification code to your email. Please enter it below.</p>
                    
                    <form class="verification-form" id="verificationForm">
                        <div class="form-group">
                            <label for="verification-code">Verification Code</label>
                            <input type="text" id="verification-code" name="verification-code" placeholder="Enter 6-digit code" required maxlength="6">
                            <div id="code-error" class="error-message"></div>
                        </div>
                        
                        <button type="button" class="submit-button" id="verifyCodeButton">
                            <span id="verifyText">Verify Code</span>
                            <span id="verifyLoading" style="display: none;">Verifying...</span>
                        </button>
                        
                        <div class="resend-link">
                            <p>Didn't receive the code? <a href="#" id="resendCodeButton">Resend</a></p>
                        </div>
                    </form>
                </div>

                <!-- Step 3: Reset Password -->
                <div class="step-content" id="step3Content">
                    <h2>Create New Password</h2>
                    <p class="instruction">Please create a new password for your account.</p>
                    
                    <form class="reset-password-form" id="resetPasswordForm">
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <div class="password-input-container">
                                <input type="password" id="new-password" name="new-password" placeholder="Enter new password" required>
                                <span class="password-toggle" id="toggleNewPassword">üëÅÔ∏è</span>
                            </div>
                            <div class="password-strength" id="passwordStrength"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">Confirm Password</label>
                            <div class="password-input-container">
                                <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm new password" required>
                                <span class="password-toggle" id="toggleConfirmPassword">üëÅÔ∏è</span>
                            </div>
                            <div class="password-match" id="passwordMatch"></div>
                        </div>
                        
                        <button type="button" class="submit-button" id="resetPasswordButton">
                            <span id="resetText">Reset Password</span>
                            <span id="resetLoading" style="display: none;">Resetting...</span>
                        </button>
                    </form>
                </div>

                <!-- Success Message -->
                <div class="success-message" id="successMessage" style="display: none;">
                    <div class="success-icon">‚úì</div>
                    <h3>Password Reset Successful!</h3>
                    <p>Your password has been successfully reset. You can now login with your new password.</p>
                    <button type="button" class="submit-button" id="goToLoginButton">Go to Login</button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Green Haven Gardening. All rights reserved.</p>
    </footer>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBwBBfN5LG6RFRezR5cBfcWKv9iKzIdAvA",
			authDomain: "green-haven-tut.firebaseapp.com",
			databaseURL: "https://green-haven-tut-default-rtdb.firebaseio.com",
			projectId: "green-haven-tut",
			storageBucket: "green-haven-tut.firebasestorage.app",
			messagingSenderId: "30246624131",
			appId: "1:30246624131:web:e5e151aa0672721512f4b6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step1Content = document.getElementById('step1Content');
        const step2Content = document.getElementById('step2Content');
        const step3Content = document.getElementById('step3Content');
        const continueButton = document.getElementById('continueButton');
        const verifyCodeButton = document.getElementById('verifyCodeButton');
        const resetPasswordButton = document.getElementById('resetPasswordButton');
        const resendCodeButton = document.getElementById('resendCodeButton');
        const goToLoginButton = document.getElementById('goToLoginButton');
        const successMessage = document.getElementById('successMessage');
        const toggleNewPassword = document.getElementById('toggleNewPassword');
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const passwordStrength = document.getElementById('passwordStrength');
        const passwordMatch = document.getElementById('passwordMatch');

        let userEmail = '';
        let verificationCode = '';

        // Step navigation functions
        function goToStep(stepNumber) {
            // Hide all steps
            step1Content.classList.remove('active');
            step2Content.classList.remove('active');
            step3Content.classList.remove('active');
            
            // Remove active class from all steps
            step1.classList.remove('active');
            step2.classList.remove('active');
            step3.classList.remove('active');
            
            // Show the selected step
            if (stepNumber === 1) {
                step1Content.classList.add('active');
                step1.classList.add('active');
            } else if (stepNumber === 2) {
                step2Content.classList.add('active');
                step2.classList.add('active');
            } else if (stepNumber === 3) {
                step3Content.classList.add('active');
                step3.classList.add('active');
            }
        }

        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Hide error message
        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
        }

        // Generate random verification code
        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            return strength;
        }

        // Update password strength indicator
        newPasswordInput.addEventListener('input', function() {
            const strength = checkPasswordStrength(this.value);
            let message = '';
            let color = 'red';
            
            if (strength === 0) {
                message = 'Very weak';
            } else if (strength === 1) {
                message = 'Weak';
            } else if (strength === 2) {
                message = 'Medium';
                color = 'orange';
            } else if (strength === 3) {
                message = 'Strong';
                color = 'green';
            } else {
                message = 'Very strong';
                color = 'darkgreen';
            }
            
            passwordStrength.textContent = message;
            passwordStrength.style.color = color;
            
            // Check if passwords match
            if (confirmPasswordInput.value) {
                if (this.value === confirmPasswordInput.value) {
                    passwordMatch.textContent = 'Passwords match';
                    passwordMatch.style.color = 'green';
                } else {
                    passwordMatch.textContent = 'Passwords do not match';
                    passwordMatch.style.color = 'red';
                }
            }
        });

        // Check if passwords match
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value === newPasswordInput.value) {
                passwordMatch.textContent = 'Passwords match';
                passwordMatch.style.color = 'green';
            } else {
                passwordMatch.textContent = 'Passwords do not match';
                passwordMatch.style.color = 'red';
            }
        });

        // Toggle password visibility
        toggleNewPassword.addEventListener('click', function() {
            if (newPasswordInput.type === 'password') {
                newPasswordInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                newPasswordInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        toggleConfirmPassword.addEventListener('click', function() {
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                confirmPasswordInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // Event listeners
        continueButton.addEventListener('click', async function() {
            const identifier = document.getElementById('user-identifier').value.trim();
            if (!identifier) {
                showError('identifier-error', 'Please enter your Haven ID or email address');
                return;
            }

            hideError('identifier-error');
            
            // Show loading state
            document.getElementById('continueText').style.display = 'none';
            document.getElementById('continueLoading').style.display = 'inline';
            continueButton.classList.add('loading');

            try {
                // Check if identifier is email or Haven ID
                let email = identifier;
                
                // If it's not an email, assume it's a Haven ID and look it up
                if (!identifier.includes('@')) {
                    const userDoc = await db.collection('users').where('havenId', '==', identifier).get();
                    if (userDoc.empty) {
                        showError('identifier-error', 'No account found with this Haven ID');
                        return;
                    }
                    email = userDoc.docs[0].data().email;
                }

                // Check if email exists in Firebase Auth
                try {
                    const methods = await auth.fetchSignInMethodsForEmail(email);
                    if (methods.length === 0) {
                        showError('identifier-error', 'No account found with this email address');
                        return;
                    }
                } catch (error) {
                    showError('identifier-error', 'Error checking account. Please try again.');
                    return;
                }

                userEmail = email;
                verificationCode = generateVerificationCode();
                
                // Store verification code in Firestore
                await db.collection('passwordResetCodes').doc(email).set({
                    code: verificationCode,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutes
                });

                // In a real application, you would send the code via email
                // For demo purposes, we'll log it to console and show an alert
                console.log(`Verification code for ${email}: ${verificationCode}`);
                alert(`Demo: Verification code sent to ${email}: ${verificationCode}`);
                
                goToStep(2);
            } catch (error) {
                console.error('Error:', error);
                showError('identifier-error', 'An error occurred. Please try again.');
            } finally {
                // Hide loading state
                document.getElementById('continueText').style.display = 'inline';
                document.getElementById('continueLoading').style.display = 'none';
                continueButton.classList.remove('loading');
            }
        });

        verifyCodeButton.addEventListener('click', async function() {
            const code = document.getElementById('verification-code').value.trim();
            if (!code || code.length !== 6) {
                showError('code-error', 'Please enter a valid 6-digit verification code');
                return;
            }

            hideError('code-error');
            
            // Show loading state
            document.getElementById('verifyText').style.display = 'none';
            document.getElementById('verifyLoading').style.display = 'inline';
            verifyCodeButton.classList.add('loading');

            try {
                // Get the stored verification code
                const codeDoc = await db.collection('passwordResetCodes').doc(userEmail).get();
                
                if (!codeDoc.exists) {
                    showError('code-error', 'Invalid or expired verification code');
                    return;
                }

                const storedCode = codeDoc.data();
                
                // Check if code is expired
                if (storedCode.expiresAt.toDate() < new Date()) {
                    showError('code-error', 'Verification code has expired. Please request a new one.');
                    return;
                }

                // Verify the code
                if (code !== storedCode.code) {
                    showError('code-error', 'Invalid verification code');
                    return;
                }

                // Code is valid, proceed to next step
                goToStep(3);
            } catch (error) {
                console.error('Error:', error);
                showError('code-error', 'An error occurred. Please try again.');
            } finally {
                // Hide loading state
                document.getElementById('verifyText').style.display = 'inline';
                document.getElementById('verifyLoading').style.display = 'none';
                verifyCodeButton.classList.remove('loading');
            }
        });

        resetPasswordButton.addEventListener('click', async function() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Check password strength
            const strength = checkPasswordStrength(newPassword);
            if (strength < 2) {
                alert('Please choose a stronger password (at least 8 characters with uppercase letters and numbers)');
                return;
            }
            
            // Show loading state
            document.getElementById('resetText').style.display = 'none';
            document.getElementById('resetLoading').style.display = 'inline';
            resetPasswordButton.classList.add('loading');

            try {
                // Update password in Firebase Auth
                // Note: In a real application, you would use Firebase Auth's reset password flow
                // For demo purposes, we're updating directly (requires recent login)
                
                // Alternative: Send password reset email
                await auth.sendPasswordResetEmail(userEmail);
                
                // Delete the used verification code
                await db.collection('passwordResetCodes').doc(userEmail).delete();
                
                // Show success message
                successMessage.style.display = 'block';
                step3Content.style.display = 'none';
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Error resetting password. Please try again.');
            } finally {
                // Hide loading state
                document.getElementById('resetText').style.display = 'inline';
                document.getElementById('resetLoading').style.display = 'none';
                resetPasswordButton.classList.remove('loading');
            }
        });

        resendCodeButton.addEventListener('click', async function(e) {
            e.preventDefault();
            
            if (!userEmail) {
                alert('Please enter your email first');
                return;
            }

            try {
                verificationCode = generateVerificationCode();
                
                // Store new verification code in Firestore
                await db.collection('passwordResetCodes').doc(userEmail).set({
                    code: verificationCode,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutes
                });

                // In a real application, you would send the code via email
                // For demo purposes, we'll log it to console and show an alert
                console.log(`New verification code for ${userEmail}: ${verificationCode}`);
                alert(`Demo: New verification code sent to ${userEmail}: ${verificationCode}`);
            } catch (error) {
                console.error('Error resending code:', error);
                alert('Error resending verification code. Please try again.');
            }
        });

        goToLoginButton.addEventListener('click', function() {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>